name: Build Android APK

on:
  push:
    branches: [ main, android-fix ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        target:
          - aarch64-linux-android
          - armv7-linux-androideabi
          - x86_64-linux-android
          - i686-linux-android
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        ndk: 25.2.9519653
        cmake: 3.22.1
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        
    - name: Setup Cargo config for Android
      run: |
        mkdir -p .cargo
        cat > .cargo/config.toml << EOF
        [target.aarch64-linux-android]
        linker = "${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
        
        [target.armv7-linux-androideabi]
        linker = "${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"
        
        [target.x86_64-linux-android]
        linker = "${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang"
        
        [target.i686-linux-android]
        linker = "${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang"
        EOF
        
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Install Tauri CLI
      run: cargo install tauri-cli --version ^2.0.0
      
    - name: Initialize Tauri Android project
      run: |
        cd src-tauri
        cargo tauri android init
        
    - name: Build Android APK (Debug)
      run: |
        cd src-tauri
        cargo tauri android build --apk --debug
        
    - name: Build Android APK (Release)
      run: |
        cd src-tauri
        cargo tauri android build --apk --release
      continue-on-error: true
      
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: android-apk-${{ matrix.target }}
        path: |
          src-tauri/gen/android/app/build/outputs/apk/debug/
          src-tauri/gen/android/app/build/outputs/apk/release/
        retention-days: 30
        
    - name: Security audit
      run: cargo audit
      continue-on-error: true